import unittest
import optics_callables
import numpy as N
from ray_bundle import RayBundle
from flat_surface import FlatGeometryManager

class TestReflective(unittest.TestCase):
    def setUp(self):
        """Set up the ray bundle and geometry"""
        dir = N.c_[[1, 1, -1], [-1, 1, -1], [-1, -1, -1], [1, -1, -1]] / N.sqrt(3)
        position = N.c_[[0,0,1], [1,-1,1], [1,1,1], [-1,1,1]]

        self._bund = RayBundle()
        self._bund.set_vertices(position)
        self._bund.set_directions(dir)
        self._bund.set_energy(N.r_[100, 200, 300, 400])
        self._bund.set_ref_index(N.r_[1, 1, 1, 1])

        self.gm = FlatGeometryManager()
        self.prm = self.gm.find_intersections(N.eye(4), self._bund)
    
    def test_with_absorptivity(self):
        """A correct bundle is generated by reflective, with energy reduced correctly"""
        reflective = optics_callables.gen_reflective(0.1)
        outg = reflective(self.gm, self._bund, N.ones(4, dtype=N.bool))
        
        correct_pts = N.zeros((3,4))
        correct_pts[:2,0] = 1
        N.testing.assert_array_equal(outg.get_vertices(), correct_pts)
        
        correct_dirs = N.c_[[1, 1, 1], [-1, 1, 1], [-1, -1, 1], [1, -1, 1]] / N.sqrt(3)
        N.testing.assert_array_equal(outg.get_directions(), correct_dirs)
        
        N.testing.assert_array_equal(outg.get_energy(), N.r_[90, 180, 270, 360])
        N.testing.assert_array_equal(outg.get_parent(), N.arange(4))
    
    def test_without_absorptivity(self):
        """Perfect mirroring works"""
        reflective = optics_callables.gen_reflective(0)
        outg = reflective(self.gm, self._bund, N.ones(4, dtype=N.bool))
        N.testing.assert_array_equal(outg.get_energy(), N.r_[100, 200, 300, 400])

class TestRefractiveHomogenous(unittest.TestCase):
    def test_all_refracted(self):
        dir = N.c_[[1, 1, -1], [-1, 1, -1], [-1, -1, -1], [1, -1, -1]] / N.sqrt(3)
        position = N.c_[[0,0,1], [1,-1,1], [1,1,1], [-1,1,1]]

        bund = RayBundle()
        bund.set_vertices(position)
        bund.set_directions(dir)
        bund.set_energy(N.r_[100, 200, 300, 400])
        bund.set_ref_index(N.r_[1, 1, 1, 1])

        gm = FlatGeometryManager()
        prm = gm.find_intersections(N.eye(4), bund)
        refractive = optics_callables.RefractiveHomogenous(1,1.5)
        selector = N.array([True, True, False, True])
        outg = refractive(gm, bund, selector)
        
        correct_pts = N.zeros((3,4))
        correct_pts[:2,0] = 1
        correct_pts = N.hstack((correct_pts[:,selector], correct_pts[:,selector]))
        N.testing.assert_array_equal(outg.get_vertices(), correct_pts)
        
        norm = N.c_[gm.get_normals(selector)[:,0]]
        correct_refl_cos = -(dir*norm).sum(axis=0)[selector]
        correct_refr_cos = -N.sqrt(1 - (1./1.5)**2*(1 - correct_refl_cos**2))
        outg_cos = (outg.get_directions()*norm).sum(axis=0)
        N.testing.assert_array_equal(outg_cos, N.r_[correct_refl_cos, correct_refr_cos])
        
        N.testing.assert_array_equal(outg.get_energy().reshape(2,-1).sum(axis=0), \
            N.r_[100, 200, 400]) # reflection and refraction sum to 100%
        N.testing.assert_array_equal(outg.get_parent(), N.tile(N.r_[0, 1, 3], 2))
    
    def test_TIR(self):
        dir = N.c_[[0, N.cos(N.pi/180), -N.sin(N.pi/180)]]
        position = N.c_[[0,0,1]]
        
        bund = RayBundle()
        bund.set_vertices(position)
        bund.set_directions(dir)
        bund.set_energy(N.r_[100])
        bund.set_ref_index(N.r_[1.5])
        
        gm = FlatGeometryManager()
        prm = gm.find_intersections(N.eye(4), bund)
        refractive = optics_callables.RefractiveHomogenous(1.,1.5)
        selector = N.ones(1, dtype=N.bool)
        outg = refractive(gm, bund, selector)
        
        self.failUnlessEqual(outg.get_vertices().shape, (3,1))
        N.testing.assert_array_equal(outg.get_directions(), 
            N.c_[[0, N.cos(N.pi/180), N.sin(N.pi/180)]])
        N.testing.assert_array_equal(outg.get_energy(), N.r_[100])
        N.testing.assert_array_equal(outg.get_parent(), N.r_[0])

